<div id="item-container">
    <label><h4>Descrição e Exame do Local</h4></label>    
    <div class="item-group form-group border p-3 mb-3">
        <div class="item-header-dark mb-2 d-flex align-items-center">
            <h5 name="item_header[]" class="mb-0">Subtítulo</h5>
            <input type="text" class="local-subtitle form-control ml-2" placeholder="Subtítulo desse bloco - deixe em branco para manter o subtítulo anterior" style="flex-grow: 1;"> <!-- Alinhamento e tamanho do input -->
        </div>
        <div class="form-group">
            <label for="local-description">Descrição e Exame do Local</label>
            <textarea class="form-control" id="local-description" name="local-description[]" rows="5" placeholder="Texto exibido no laudo."></textarea>
        </div>    
        <div class="d-flex align-items-center">
            <input type="hidden" id="local-img-to-text-base64" class="local-img-to-text-base64" name="local-img-to-text-base64[]">  <!-- Input invisível para armazenar a imagem em Base64 -->
            <input type="file" id="upload-local-image" class="upload-local-image" name="upload-local-image[]">
            <div class="form-check form-group flex-grow-1 mx-3 w-100">
                <label for="label-local-img">Legenda da Imagem</label>
                <input type="text" class="form-control label-local-img" id="label-local-img" name="label-local-img[]" value="" placeholder="Legenda da imagem selecionada.">
            </div>
            <button type="button" class="btn btn-secondary ml-auto add-item">+</button>
        </div>
    </div>
</div>


<script>

    function addNewContainer(button) {
        // Seleciona o container original, que é o "item-group" mais próximo do botão clicado
        const container = button.closest('.item-group');
    
        // Clona o container original
        const newContainer = container.cloneNode(true);
    
        // Limpa os campos do container clonado
        newContainer.querySelector('textarea').value = '';
        newContainer.querySelector('.local-img-to-text-base64').value = '';
        newContainer.querySelector('.upload-local-image').value = '';
        newContainer.querySelector('input[type="text"]').value = 'Item examinado.';
        newContainer.querySelector('.local-subtitle').value = '';
        newContainer.querySelector('.label-local-img').value = '';
    
        // Remove o botão "-" antigo, caso exista, para evitar duplicação
        const existingRemoveButton = newContainer.querySelector('.remove-item');
        if (existingRemoveButton) {
            existingRemoveButton.remove();
        }
    
        // Substitui o evento do botão "+" do novo container
        const newAddButton = newContainer.querySelector('.add-item');
        newAddButton.addEventListener('click', function () {
            addNewContainer(this);  // O novo botão "+" também funcionará corretamente
        });
    
        // Cria o botão "-" para remover o novo container
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.classList.add('btn', 'btn-danger', 'ml-2', 'remove-item');
        removeButton.innerText = '-';
    
        // Insere o botão "-" no container clonado
        const buttonContainer = newContainer.querySelector('.add-item').parentNode;
        buttonContainer.appendChild(removeButton);
    
        // Adiciona o evento para remover o container ao clicar no botão "-"
        removeButton.addEventListener('click', function () {
            newContainer.remove();
        });
    
        // Insere o novo container logo após o container original
        container.insertAdjacentElement('afterend', newContainer);
    
        // Evento de mudança para o campo de upload de imagem no novo container
        newContainer.querySelector('.upload-local-image').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('Nenhum arquivo selecionado');
                return;
            }
            const hiddenInputFile = newContainer.querySelector('.local-img-to-text-base64');
            handleImageResize(file, hiddenInputFile);
            alert('A imagem foi carregada, editada, e convertida para txt base64.');
        });
    }
    
    document.querySelector('#upload-local-image').addEventListener('change', function(event){
        const file = event.target.files[0];
            if (!file) {
                alert('Nenhum arquivo selecionado');
                return;
            }
            const hiddenInputFile = document.querySelector('.local-img-to-text-base64');
            handleImageResize(file, hiddenInputFile);
            alert('A imagem foi carregada, editada, e convertida para txt base64.');
    });

    function initializeAddButtons() {
        document.querySelectorAll('.add-item').forEach(button => {
            button.addEventListener('click', function () {
                addNewContainer(this);
            });
        });
    }
    
    // Inicializa os eventos para os botões "+" na carga da página
    initializeAddButtons();

</script>